<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="page-title">Cargando...</title>
    
    <link id="dynamic-favicon" rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Caveat:wght@700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --color-principal: #d63384; 
            --fondo: #ffffff; 
            --texto: #333;
            --col-prod-titulo: #333;
            --col-prod-desc: #666;
            --col-prod-precio: #d63384;
            --col-menu-cat: #0056b3; 
            --fuente-actual: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html { scroll-behavior: smooth; }
        body { font-family: var(--fuente-actual); background: var(--fondo); margin: 0; color: var(--texto); display: flex; flex-direction: column; min-height: 100vh; position: relative; }

        .nav-container { position: sticky; top: 0; background: white; padding: 5px 0; z-index: 1000; border-bottom: 1px solid #eee; text-align: center; }
        #main-nav { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 5px; }

        .nav-link { color: var(--col-menu-cat); text-decoration: underline; font-size: 0.85rem; cursor: pointer; border: none; background: none; font-weight: 700; padding: 5px 10px; margin: 0; display: inline-block; font-family: inherit; }
        .nav-separator { width: 1px; height: 15px; background-color: #ccc; display: inline-block; }

        .category-section { padding: 20px 20px 40px; max-width: 1200px; margin: 0 auto; scroll-margin-top: 60px; }
        header { text-align: center; padding: 10px 10px; position: relative; }
        .logo-img { width: 100px; border-radius: 12px; margin-bottom: 5px; display: none; margin-inline: auto; }
        header h1 { margin: 5px 0; font-size: 1.4rem; padding-top: 20px; }
        
        .category-title { font-size: 1.6rem; color: var(--color-principal); text-align: center; text-transform: uppercase; margin-bottom: 30px; border-bottom: 2px solid var(--color-principal); display: inline-block; left: 50%; transform: translateX(-50%); position: relative; }
        
        .subcat-title { width: 100%; font-size: 1.1rem; color: #555; font-weight: 700; margin: 20px 0 15px; text-align: left; border-left: 4px solid var(--color-principal); padding-left: 10px; text-transform: uppercase; }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .grid { grid-template-columns: repeat(1, 1fr); } }

        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
        
        .card img { 
            width: 100%; 
            height: auto; 
            aspect-ratio: auto; 
            object-fit: contain; 
            background-color: #f8f8f8; 
            max-height: 500px; 
            display: block;
        }

        .card-body { padding: 15px; text-align: center; }
        .card-body h3 { color: var(--col-prod-titulo); margin: 10px 0; font-size: 1.1rem; }
        
        .p-description { 
            font-size: 0.8rem; 
            color: var(--col-prod-desc); 
            margin: 10px 0; 
            min-height: 40px; 
            text-align: justify; 
            text-wrap: pretty; 
        }
        
        .p-price { font-weight: 700; color: var(--col-prod-precio); font-size: 1.1rem; margin: 0; }

        .admin-btns { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; padding: 0 10px; }
        .btn-edit { background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .btn-del { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        .top-controls { position: absolute; top: 10px; right: 10px; z-index: 1100; display: flex; align-items: center; gap: 10px; }
        .control-item { background: rgba(255,255,255,0.9); padding: 5px 12px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; border: 1px solid #eee; }
        
        #fs-wrapper { display: none; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-principal); }
        input:checked + .slider:before { transform: translateX(20px); }

        #admin-panel { display: none; background: #fff; padding: 25px; border: 2px solid var(--color-principal); border-radius: 20px; max-width: 800px; margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .admin-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit; }
        
        .color-preview-box { width: 100%; height: 30px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 5px; }
        .btn-save { background: #2ecc71; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        footer { background: #f9f9f9; padding: 40px 20px; border-top: 1px solid #eee; margin-top: auto; }
        .footer-grid { display: flex; max-width: 1200px; margin: 0 auto; gap: 40px; align-items: flex-start; flex-wrap: wrap; }
        .footer-left { flex: 1.5; min-width: 300px; width: 100%; }
        .footer-right { flex: 1; min-width: 250px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .map-wrapper { width: 100%; height: 350px; border-radius: 15px; overflow: hidden; border: 1px solid #ddd; background: #eee; position: relative; }
        .map-wrapper iframe, .map-wrapper img { width: 100% !important; height: 100% !important; border: 0; object-fit: cover; }
        .footer-logo { width: 220px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .social-tag-footer { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }

        #product-modal, #login-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 450px; position: relative; max-height: 90vh; overflow-y: auto; }
        .social-tag { background: #f0f0f0; padding: 8px 12px; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-size: 0.8rem; margin-bottom: 5px; border: 1px solid #ddd; }

        @media print {
            html, body { height: auto !important; min-height: auto !important; display: block !important; overflow: visible !important; }
            #admin-panel, .nav-container, .top-controls, .admin-btns, #login-modal, #product-modal { display: none !important; }
            header, main, footer { display: block !important; opacity: 1 !important; visibility: visible !important; }
            .grid { display: block !important; }
            .card { page-break-inside: avoid; display: flex !important; flex-direction: row !important; align-items: center; border: 1px solid #eee; margin-bottom: 10px; text-align: left; }
            .card img { width: 120px !important; aspect-ratio: 1/1 !important; }
            .card-body { padding: 10px; text-align: left !important; flex: 1; }
            .category-section { page-break-inside: auto; }
            .map-wrapper { display: block !important; height: 300px !important; visibility: visible !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<header>
    <div class="top-controls">
        <div id="fs-wrapper" class="control-item">
            <span style="font-size: 10px; font-weight: bold; color: #666;">PANTALLA</span>
            <label class="switch"><input type="checkbox" id="fs-toggle" onchange="toggleFS()"><span class="slider"></span></label>
        </div>
        <div class="control-item">
            <span style="font-size: 10px; font-weight: bold; color: #666;">ADMIN</span>
            <label class="switch"><input type="checkbox" id="mode-toggle" onchange="toggleAdmin()"><span class="slider"></span></label>
        </div>
    </div>
    <img src="" id="logo-main" class="logo-img">
    <h1 id="display-titulo">Cargando...</h1>
</header>

<div class="nav-container"><nav id="main-nav"></nav></div>

<main id="menu-sections"></main>

<footer>
    <div class="footer-grid">
        <div class="footer-left"><div id="map-container" class="map-wrapper">Mapa</div></div>
        <div class="footer-right">
            <img src="" id="logo-footer" class="footer-logo">
            <p id="footer-dir" style="font-weight: 600; margin: 0 0 8px 0; font-size: 1.1rem;"></p>
            <div id="footer-tels" style="font-size: 1rem; color: #666; text-align: center;"></div>
            <div id="footer-socials" class="social-tag-footer"></div>
        </div>
    </div>
    <p id="footer-copy" style="font-size: 0.8rem; color: #999; text-align: center; margin-top: 40px; width: 100%; display: block;"></p>
</footer>

<section id="admin-panel">
    <div class="admin-section">
        <h3>üè† Identidad y Estilo</h3>
        <button onclick="window.print()" style="background:#dc3545; color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:20px;">
            <i class="fas fa-file-pdf"></i> IMPRIMIR MEN√ö COMPLETO (PDF)
        </button>
        <label>Nombre del Negocio:</label><input type="text" id="adm-titulo" oninput="actualizarConfig()">
        <label>T√≠tulo en Pesta√±a:</label><input type="text" id="adm-tab-title" oninput="actualizarConfig()">
        <label>Texto Copyright:</label><input type="text" id="adm-copy" oninput="actualizarConfig()">
        <label>Tipo de Letra:</label>
        <select id="adm-font" onchange="actualizarConfig()">
            <option value="'Poppins', sans-serif">Moderna (Poppins)</option>
            <option value="'Montserrat', sans-serif">Llamativa (Montserrat)</option>
            <option value="'Playfair Display', serif">Elegante (Playfair)</option>
            <option value="'Roboto Slab', serif">Cl√°sica (Roboto Slab)</option>
            <option value="'Open Sans', sans-serif">Limpia (Open Sans)</option>
            <option value="'Caveat', cursive">Escrita a mano (Caveat)</option>
        </select>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
            <div><label>Principal:</label><div id="pv-main" class="color-preview-box"></div><input type="color" id="adm-col-main" oninput="actualizarConfig()"></div>
            <div><label>T√≠tulo Prod:</label><div id="pv-t" class="color-preview-box"></div><input type="color" id="adm-col-t" oninput="actualizarConfig()"></div>
            <div><label>Desc. Prod:</label><div id="pv-d" class="color-preview-box"></div><input type="color" id="adm-col-d" oninput="actualizarConfig()"></div>
            <div><label>Precio Prod:</label><div id="pv-p" class="color-preview-box"></div><input type="color" id="adm-col-p" oninput="actualizarConfig()"></div>
            <div><label>Men√∫ Cat:</label><div id="pv-cat" class="color-preview-box"></div><input type="color" id="adm-col-cat" oninput="actualizarConfig()"></div>
        </div>
        <label>Logo Principal:</label><input type="file" onchange="subirImagenExtra(this, 'logo')">
        <label>Logo Footer:</label><input type="file" onchange="subirImagenExtra(this, 'logoFooter')">
        <label>Favicon:</label><input type="file" onchange="subirImagenExtra(this, 'favicon')">
    </div>

    <div class="admin-section">
        <h3>üîê Seguridad</h3>
        <label>Nueva Contrase√±a Admin:</label>
        <input type="password" id="adm-new-pass" placeholder="Ingresa nueva clave" autocomplete="new-password">
        <button onclick="cambiarClave()" style="background:var(--color-principal); color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; font-weight:bold;">ACTUALIZAR CONTRASE√ëA</button>
    </div>

    <div class="admin-section">
        <h3>üîó Redes Sociales</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="new-social-type">
                <option value="fab fa-facebook">Facebook</option>
                <option value="fab fa-instagram">Instagram</option>
                <option value="fab fa-whatsapp">WhatsApp</option>
                <option value="fab fa-tiktok">TikTok</option>
                <option value="fas fa-link">Enlace</option>
            </select>
            <input type="text" id="new-social-name" placeholder="Nombre">
        </div>
        <input type="text" id="new-social-url" placeholder="URL">
        <button onclick="agregarRed()" style="background:var(--color-principal); color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer;">A√±adir Red</button>
        <div id="social-manage-list" style="margin-top:15px;"></div>
    </div>

    <div class="admin-section">
        <h3>üìç Ubicaci√≥n</h3>
        <label>Direcci√≥n:</label><input type="text" id="adm-dir" oninput="actualizarConfig()">
        <label>Fijo:</label><input type="text" id="adm-tel-fijo" oninput="actualizarConfig()">
        <label>Celular:</label><input type="text" id="adm-tel-cel" oninput="actualizarConfig()">
        
        <div style="background:#f0f0f0; padding:15px; border-radius:10px; margin-bottom:15px;">
            <label style="display:flex; align-items:center; gap:10px; margin-bottom:15px; cursor:pointer;">
                <span>¬øUsar Mapa Interactivo (Iframe)?</span>
                <label class="switch"><input type="checkbox" id="adm-prefer-iframe" onchange="actualizarConfig()"><span class="slider"></span></label>
            </label>
            <label>C√≥digo Iframe:</label><textarea id="adm-map" oninput="actualizarConfig()" placeholder="Pega el <iframe> aqu√≠"></textarea>
            <label>Imagen del Mapa (Captura):</label><input type="file" onchange="subirImagenExtra(this, 'mapaImg')">
        </div>
    </div>

    <div class="admin-section">
        <h3>üìÇ Categor√≠as</h3>
        <div style="display:flex; gap:10px;">
            <input type="text" id="new-cat-input" placeholder="Categor√≠a..." style="margin:0;">
            <button onclick="agregarCat()" style="background:var(--color-principal); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">+</button>
        </div>
        <div id="cat-manage-list" style="display:flex; flex-direction: column; gap:10px; margin-top:10px;"></div>
    </div>

    <div class="admin-section">
        <h3 id="form-p-title">Gesti√≥n Platillo</h3>
        <input type="hidden" id="edit-index" value="-1">
        <label>Nombre:</label><input type="text" id="p-nom">
        <label>Precio:</label><input type="text" id="p-pre">
        <label>Descripci√≥n:</label><textarea id="p-desc"></textarea>
        <label>Categor√≠a:</label><select id="p-cat"></select>
        <label>Subcategor√≠a (Opcional):</label><input type="text" id="p-subcat" placeholder="Ej: Especiales, Importadas...">
        <label>Foto:</label><input type="file" id="p-img" accept="image/*">
        <button class="btn-save" onclick="guardarPlatillo()">GUARDAR EN LOCAL</button>
        <button id="btn-cancel" style="display:none; margin-top:10px; background:#888; color:white; border:none; width:100%; padding:10px; border-radius:10px; cursor:pointer;" onclick="resetForm()">CANCELAR</button>
    </div>

    <div class="admin-section" style="background:#e3f2fd; border: 1px solid #2196f3; padding:15px; border-radius:15px;">
        <h3>üíæ Base de Datos (JSON)</h3>
        <button onclick="cargarDesdeRepo()" style="background:#4CAF50; color:white; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-bottom:10px;">
            <i class="fas fa-sync"></i> SINCRONIZAR DESDE GITHUB (menu_respaldo.json)
        </button>
        <button onclick="exportarJSON()" style="background:#2196F3; color:white; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-bottom:10px;">DESCARGAR ARCHIVO JSON</button>
        <button onclick="document.getElementById('file-import').click()" style="background:#9c27b0; color:white; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer;">CARGAR ARCHIVO LOCAL (PC/MOVIL)</button>
        <input type="file" id="file-import" style="display:none" onchange="importarJSON(this)">
        
        <button onclick="borrarTodo()" style="background:#dc3545; color:white; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-top:10px;">
            ‚ö†Ô∏è BORRAR TODOS LOS DATOS (RESET)
        </button>
    </div>
</section>

<div id="login-modal">
    <div class="modal-content" style="text-align:center;">
        <h3>Admin</h3>
        <input type="password" id="pass-val" placeholder="Pass" autocomplete="new-password" onfocus="this.value=''">
        <button class="btn-save" onclick="login()">ENTRAR</button>
        <button onclick="cerrarLogin()" style="margin-top:10px; background:none; border:none; color:red; cursor:pointer;">Cancelar</button>
    </div>
</div>

<div id="product-modal" onclick="this.style.display='none'">
    <div class="modal-content" id="modal-detail" style="text-align:center;"></div>
</div>

<script>
    let categorias = JSON.parse(localStorage.getItem('cats')) || ["Entradas"];
    let productos = JSON.parse(localStorage.getItem('prods')) || [];
    let redes = JSON.parse(localStorage.getItem('redes')) || [];
    let config = JSON.parse(localStorage.getItem('conf')) || { 
        titulo: "Negocio", tabTitle: "Men√∫", copy: "¬© 2026", 
        dir: "", telFijo: "", telCel: "", map: "",
        preferIframe: false,
        colMain: "#d63384", colT: "#333333", colD: "#666666", colP: "#d63384", colCat: "#0056b3",
        pass: "1234",
        fontFamily: "'Poppins', sans-serif"
    };
    let logo = localStorage.getItem('logo') || "";
    let logoFooter = localStorage.getItem('logoFooter') || "";
    let favicon = localStorage.getItem('favicon') || "";
    let mapaImg = localStorage.getItem('mapaImg') || "";

    function render() {
        document.documentElement.style.setProperty('--color-principal', config.colMain);
        document.documentElement.style.setProperty('--col-prod-titulo', config.colT);
        document.documentElement.style.setProperty('--col-prod-desc', config.colD);
        document.documentElement.style.setProperty('--col-prod-precio', config.colP);
        document.documentElement.style.setProperty('--col-menu-cat', config.colCat);
        document.documentElement.style.setProperty('--fuente-actual', config.fontFamily || "'Poppins', sans-serif");

        document.getElementById('adm-titulo').value = config.titulo;
        document.getElementById('adm-tab-title').value = config.tabTitle;
        document.getElementById('adm-copy').value = config.copy;
        document.getElementById('adm-dir').value = config.dir;
        document.getElementById('adm-tel-fijo').value = config.telFijo;
        document.getElementById('adm-tel-cel').value = config.telCel;
        document.getElementById('adm-map').value = config.map;
        document.getElementById('adm-prefer-iframe').checked = config.preferIframe;
        document.getElementById('adm-font').value = config.fontFamily || "'Poppins', sans-serif";

        document.getElementById('adm-col-main').value = config.colMain;
        document.getElementById('pv-main').style.backgroundColor = config.colMain;
        document.getElementById('adm-col-t').value = config.colT;
        document.getElementById('pv-t').style.backgroundColor = config.colT;
        document.getElementById('adm-col-d').value = config.colD;
        document.getElementById('pv-d').style.backgroundColor = config.colD;
        document.getElementById('adm-col-p').value = config.colP;
        document.getElementById('pv-p').style.backgroundColor = config.colP;
        document.getElementById('adm-col-cat').value = config.colCat;
        document.getElementById('pv-cat').style.backgroundColor = config.colCat;

        document.getElementById('display-titulo').innerText = config.titulo;
        document.title = config.tabTitle;
        document.getElementById('footer-copy').innerText = config.copy;
        document.getElementById('footer-dir').innerText = config.dir;
        
        if(logo) { let imgH = document.getElementById('logo-main'); imgH.src = logo; imgH.style.display = 'block'; }
        if(logoFooter) { let imgF = document.getElementById('logo-footer'); imgF.src = logoFooter; imgF.style.display = 'block'; }
        if(favicon) document.getElementById('dynamic-favicon').href = favicon;

        let mapContainer = document.getElementById('map-container');
        if (config.preferIframe && navigator.onLine && config.map) {
            mapContainer.innerHTML = config.map;
        } else if (mapaImg) {
            mapContainer.innerHTML = `<img src="${mapaImg}">`;
        } else {
            mapContainer.innerHTML = "<i>Mapa no disponible.</i>";
        }

        let telsHTML = "";
        if(config.telFijo) telsHTML += `<div><i class="fas fa-phone-alt"></i> ${config.telFijo}</div>`;
        if(config.telCel) telsHTML += `<div><i class="fas fa-mobile-alt"></i> ${config.telCel}</div>`;
        document.getElementById('footer-tels').innerHTML = telsHTML;

        let fSoc = document.getElementById('footer-socials'); fSoc.innerHTML = '';
        redes.forEach(r => { fSoc.innerHTML += `<a href="${r.url}" target="_blank"><i class="${r.icon}" style="font-size:1.8rem; color:var(--color-principal);"></i></a>`; });

        let nav = document.getElementById('main-nav'); nav.innerHTML = '';
        categorias.forEach((c, index) => {
            let btn = document.createElement('button'); btn.className = 'nav-link'; btn.innerText = c;
            btn.onclick = () => { document.getElementById(`section-${c.replace(/\s+/g, '-').toLowerCase()}`).scrollIntoView({ behavior: 'smooth' }); };
            nav.appendChild(btn);
            if (index < categorias.length - 1) { let sep = document.createElement('span'); sep.className = 'nav-separator'; nav.appendChild(sep); }
        });

        actualizarUIAdmin();
        let menu = document.getElementById('menu-sections'); menu.innerHTML = '';
        let isAdmin = document.getElementById('admin-panel').style.display === 'block';

        categorias.forEach(cat => {
            let sect = document.createElement('section'); 
            sect.className = 'category-section'; sect.id = `section-${cat.replace(/\s+/g, '-').toLowerCase()}`;
            
            let h2 = document.createElement('h2'); h2.className = 'category-title'; h2.innerText = cat;
            sect.appendChild(h2);

            let pDeCat = productos.map((p, i) => ({...p, realIdx: i})).filter(p => p.cat === cat);
            let grupos = {};
            pDeCat.forEach(p => {
                let sub = p.subcat || "_generales";
                if(!grupos[sub]) grupos[sub] = [];
                grupos[sub].push(p);
            });

            if(grupos["_generales"]) {
                let grid = document.createElement('div'); grid.className = 'grid';
                grupos["_generales"].forEach(p => grid.appendChild(crearCard(p, isAdmin)));
                sect.appendChild(grid);
            }

            for(let sub in grupos) {
                if(sub === "_generales") continue;
                let subT = document.createElement('div'); subT.className = 'subcat-title'; subT.innerText = sub;
                sect.appendChild(subT);

                let gridSub = document.createElement('div'); gridSub.className = 'grid';
                grupos[sub].forEach(p => gridSub.appendChild(crearCard(p, isAdmin)));
                sect.appendChild(gridSub);
            }
            menu.appendChild(sect);
        });
    }

    function crearCard(p, isAdmin) {
        let card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<img src="${p.img}"><div class="card-body"><h3>${p.nom}</h3><p class="p-description">${p.desc}</p><p class="p-price">$${p.pre}</p></div>`;
        if(isAdmin) card.innerHTML += `<div class="admin-btns"><button class="btn-edit" onclick="event.stopPropagation(); prepararEdit(${p.realIdx})">E</button><button class="btn-del" onclick="event.stopPropagation(); eliminarP(${p.realIdx})">X</button></div>`;
        card.onclick = () => verDetalle(p);
        return card;
    }

    async function guardarPlatillo() { 
        let n=document.getElementById('p-nom').value, p=document.getElementById('p-pre').value, d=document.getElementById('p-desc').value, c=document.getElementById('p-cat').value, sub=document.getElementById('p-subcat').value.trim(), f=document.getElementById('p-img').files[0], ei=parseInt(document.getElementById('edit-index').value); 
        if(!n||!p) return; 
        let img = (ei>-1)?productos[ei].img:""; if(f) img = await comprimirImagen(f); 
        let np={nom:n, pre:p, desc:d, cat:c, subcat:sub, img:img};
        if(ei>-1) productos[ei]=np; else productos.push(np); 
        localStorage.setItem('prods', JSON.stringify(productos)); resetForm(); render(); 
    }

    function prepararEdit(i) { 
        let p=productos[i]; 
        document.getElementById('p-nom').value=p.nom; document.getElementById('p-pre').value=p.pre; 
        document.getElementById('p-desc').value=p.desc; document.getElementById('p-cat').value=p.cat; 
        document.getElementById('p-subcat').value=p.subcat || ""; document.getElementById('edit-index').value=i; 
        document.getElementById('form-p-title').innerText="Editando"; document.getElementById('btn-cancel').style.display='block';
        window.scrollTo(0, document.getElementById('admin-panel').offsetTop);
    }

    function eliminarP(i) { if(confirm("¬øEliminar?")){ productos.splice(i, 1); localStorage.setItem('prods', JSON.stringify(productos)); render(); } }
    
    function actualizarUIAdmin() { 
        document.getElementById('p-cat').innerHTML = categorias.map(c => `<option value="${c}">${c}</option>`).join(''); 
        document.getElementById('cat-manage-list').innerHTML = categorias.map(c => {
            let subs = [...new Set(productos.filter(p => p.cat === c && p.subcat).map(p => p.subcat))];
            let subsHTML = subs.map(s => `<div style="margin-left:20px; font-size:0.85em; color:#666;">‚Ü≥ ${s} <i class="fas fa-pencil-alt" onclick="editarSubcat('${c}', '${s}')"></i> <i class="fas fa-times" onclick="borrarSubcat('${c}', '${s}')"></i></div>`).join('');
            return `<div class="social-tag">${c} <i class="fas fa-edit" onclick="editarCat('${c}')"></i> <i class="fas fa-times" onclick="borrarCat('${c}')"></i></div>${subsHTML}`;
        }).join('');
        document.getElementById('social-manage-list').innerHTML = redes.map((r, i) => `<div class="social-tag"><i class="${r.icon}"></i> ${r.name} <i class="fas fa-trash" onclick="borrarRed(${i})"></i></div>`).join(''); 
    }

    function actualizarConfig() { 
        config.titulo = document.getElementById('adm-titulo').value; 
        config.tabTitle = document.getElementById('adm-tab-title').value; 
        config.copy = document.getElementById('adm-copy').value; 
        config.dir = document.getElementById('adm-dir').value; 
        config.telFijo = document.getElementById('adm-tel-fijo').value; 
        config.telCel = document.getElementById('adm-tel-cel').value; 
        config.map = document.getElementById('adm-map').value; 
        config.preferIframe = document.getElementById('adm-prefer-iframe').checked;
        config.colMain = document.getElementById('adm-col-main').value; 
        config.colT = document.getElementById('adm-col-t').value; 
        config.colD = document.getElementById('adm-col-d').value; 
        config.colP = document.getElementById('adm-col-p').value; 
        config.colCat = document.getElementById('adm-col-cat').value; 
        config.fontFamily = document.getElementById('adm-font').value;
        localStorage.setItem('conf', JSON.stringify(config)); render(); 
    }

    function cambiarClave() { let n = document.getElementById('adm-new-pass').value; if(n){config.pass=n; localStorage.setItem('conf', JSON.stringify(config)); alert("OK");} }
    async function subirImagenExtra(input, tipo) { if(!input.files[0]) return; let b = await comprimirImagen(input.files[0]); localStorage.setItem(tipo, b); if(tipo==='logo') logo=b; location.reload(); }
    function agregarRed() { let i=document.getElementById('new-social-type').value, n=document.getElementById('new-social-name').value, u=document.getElementById('new-social-url').value; if(n&&u){redes.push({icon:i,name:n,url:u}); localStorage.setItem('redes',JSON.stringify(redes)); render();} }
    function borrarRed(i) { redes.splice(i, 1); localStorage.setItem('redes', JSON.stringify(redes)); render(); }
    function agregarCat() { let v = document.getElementById('new-cat-input').value.trim(); if(v && !categorias.includes(v)) { categorias.push(v); localStorage.setItem('cats', JSON.stringify(categorias)); render(); } document.getElementById('new-cat-input').value = ''; }
    function borrarCat(c) { if(confirm("?")) { categorias = categorias.filter(x => x !== c); productos = productos.filter(p => p.cat !== c); localStorage.setItem('cats', JSON.stringify(categorias)); render(); } }
    
    function resetForm() { 
        document.getElementById('p-nom').value=''; 
        document.getElementById('p-pre').value=''; 
        document.getElementById('p-desc').value=''; 
        document.getElementById('p-subcat').value=''; 
        document.getElementById('p-img').value=''; 
        document.getElementById('edit-index').value='-1'; 
        document.getElementById('form-p-title').innerText="Gesti√≥n Platillo"; 
        document.getElementById('btn-cancel').style.display='none';
    }

    function comprimirImagen(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            }
        });
    }

    function exportarJSON() {
        const data = { cats: categorias, prods: productos, redes: redes, conf: config, logo: logo, logoFooter: logoFooter, favicon: favicon, mapaImg: mapaImg };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const downNode = document.createElement('a');
        downNode.setAttribute("href", dataStr);
        downNode.setAttribute("download", "menu_respaldo.json");
        document.body.appendChild(downNode);
        downNode.click();
        downNode.remove();
    }

    function importarJSON(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            aplicarData(JSON.parse(e.target.result));
            location.reload(); /* Solo recarga si se importa manualmente */
        };
        reader.readAsText(file);
    }

    async function cargarDesdeRepo() {
        try {
            const response = await fetch('menu_respaldo.json');
            if (!response.ok) throw new Error("No se encontr√≥ el archivo.");
            const data = await response.json();
            aplicarData(data);
            console.log("Sincronizado desde GitHub");
        } catch (err) {
            console.log("Usando base de datos local.");
            render();
        }
    }

    function aplicarData(data) {
        try {
            if (data.cats) { categorias = data.cats; localStorage.setItem('cats', JSON.stringify(data.cats)); }
            if (data.prods) { productos = data.prods; localStorage.setItem('prods', JSON.stringify(data.prods)); }
            if (data.redes) { redes = data.redes; localStorage.setItem('redes', JSON.stringify(data.redes)); }
            if (data.conf) { config = data.conf; localStorage.setItem('conf', JSON.stringify(data.conf)); }
            if (data.logo) { logo = data.logo; localStorage.setItem('logo', data.logo); }
            if (data.logoFooter) { logoFooter = data.logoFooter; localStorage.setItem('logoFooter', data.logoFooter); }
            if (data.favicon) { favicon = data.favicon; localStorage.setItem('favicon', data.favicon); }
            if (data.mapaImg) { mapaImg = data.mapaImg; localStorage.setItem('mapaImg', data.mapaImg); }
            render();
        } catch (err) {
            console.error("Error al aplicar datos.");
            render();
        }
    }

    function toggleAdmin() {
        const isAdmin = document.getElementById('mode-toggle').checked;
        if(isAdmin) document.getElementById('login-modal').style.display = 'flex';
        else { 
            document.getElementById('admin-panel').style.display = 'none'; 
            document.getElementById('fs-wrapper').style.display = 'none'; 
            render(); 
        }
    }

    function login() {
        if(document.getElementById('pass-val').value === config.pass || document.getElementById('pass-val').value === "1234") {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('fs-wrapper').style.display = 'flex';
            render();
        } else alert("Clave incorrecta");
    }

    function cerrarLogin() {
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('mode-toggle').checked = false;
    }

    function toggleFS() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    function verDetalle(p) {
        document.getElementById('modal-detail').innerHTML = `<img src="${p.img}" style="width:100%;max-height:300px;object-fit:contain;border-radius:10px;"><h2 style="color:var(--color-principal)">${p.nom}</h2><p style="text-align:justify; text-wrap: pretty;">${p.desc}</p><h3 style="color:var(--col-prod-precio)">$${p.pre}</h3><button onclick="document.getElementById('product-modal').style.display='none'" style="margin-top:15px;background:var(--color-principal);color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer">Cerrar</button>`;
        document.getElementById('product-modal').style.display = 'flex';
    }

    function borrarTodo() {
        if(confirm("PELIGRO: ¬øEst√°s seguro de borrar TODO el men√∫ y las fotos?")) {
            localStorage.clear();
            location.reload();
        }
    }

    /* CAMBIO FINAL: Carga el repo autom√°ticamente al entrar */
    cargarDesdeRepo();
</script>
</body>
</html>